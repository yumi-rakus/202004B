<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ラクラクカリー -注文確認</title>
	<link th:href="@{../css/bootstrap.css}" rel="stylesheet">
	<link th:href="@{../css/curry.css}" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/drawer/3.2.2/css/drawer.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jQuery-Validation-Engine/2.6.4/validationEngine.jquery.min.css" type="text/css"/>
	<link th:href="@{/css/drawer.css}" rel="stylesheet">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jQuery-Validation-Engine/2.6.4/jquery-1.8.2.min.js" type="text/javascript"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jQuery-Validation-Engine/2.6.4/languages/jquery.validationEngine-ja.min.js" type="text/javascript" charset="utf-8"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jQuery-Validation-Engine/2.6.4/jquery.validationEngine.min.js" type="text/javascript" charset="utf-8"></script>
	<script src="https://ajaxzip3.github.io/ajaxzip3.js" charset="UTF-8"></script>
	<!-- <script src="//code.jquery.com/jquery-1.12.1.min.js"></script> -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/iScroll/5.2.0/iscroll.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/drawer/3.2.2/js/drawer.min.js"></script>
	<script>
		jQuery(function ($) {
			$(document).ready(function () {			
				$('.drawer').drawer();
			});
			$(document).ready(function() {
				$("#orderForm").validationEngine();
			});
		});
	</script>
<script type="text/javascript">
	var toDoubleDigits = function(num) {
		num += "";
		if (num.length === 1) {
			num = "0" + num;
		}
		return num;
	};

	window.onload = function() {
		var date = new Date();
		var year = toDoubleDigits(date.getFullYear());
		var month = toDoubleDigits((date.getMonth() + 1));
		var day = toDoubleDigits(date.getDate());
		var today = year + '-' + month + '-' + day;
		document.getElementById('date').setAttribute('min', today);
	}
</script>
<!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body style="text-align: center" class="drawer drawer--left">
	<div class="container">
		<button type="button" class="drawer-toggle drawer-hamburger">
			<span class="sr-only">toggle navigation</span> <span
				class="drawer-hamburger-icon"></span>
		</button>
		<nav class="drawer-nav" role="navigation">
			<ul class="drawer-menu">
				<li class="side-menu"><span style="font-weight: bold"> <span
						sec:authorize="isAuthenticated()"> <span
							sec:authentication="principal.user.name"></span>さん&nbsp;
					</span> <span sec:authorize="isAnonymous()"> <span>ゲストさん&nbsp;</span>
					</span>
				</span></li>
				<span sec:authorize="isAuthenticated()">
					<li class="side-menu"><a th:href="@{/mypage}"
						class="side-content">マイページ</a></li>
				</span>
				<li class="side-menu"><a href="item_list_curry.html"
					th:href="@{/edit-mypage}" class="side-content">ユーザ情報変更</a>&nbsp;&nbsp;</li>
				<li class="side-menu"><a href="cart_list.html"
					th:href="@{/favorite}" class="side-content">お気に入り</a>&nbsp;&nbsp;
				</li>
				<li class="side-menu"><a th:href="@{/pdf/allergy.pdf}"
					target="_blank" class="side-content">アレルギー情報</a>&nbsp;&nbsp;</li>
			</ul>
		</nav>
		<span th:include="fragment-part::frag_nav"></span>

		<!-- 購入ステップ -->
		<div id="stepHeader">
			<div class="header-inner">
				<div class="header-step-border"></div>
				<ul class="header-step">
					<li class="">ショッピングカート</li>
					<li class="">ログイン</li>
					<li class="on-after">注文内容確認</li>
				</ul>
			</div>
		</div>
	</div>

	<!-- table -->
	<div class="row">
		<div
			class="table-responsive col-lg-offset-1 col-lg-10 col-md-offset-1 col-md-10 col-sm-10 col-xs-12">
			<h3 class="text-center">注文内容確認</h3>
			<table class="table table-striped item-list-table">
				<tbody>
					<tr>
						<th width="150px">
							<div class="text-center">商品名</div>
						</th>
						<th width="160px">
							<div class="text-center">サイズ、価格(税抜)、数量</div>
						</th>
						<th width="150px">
							<div class="text-center">ライス</div>
						</th>
						<th width="230px">
							<div class="text-center">トッピング、価格(税抜)</div>
						</th>
						<th width="150px">
							<div class="text-center">小計</div>
						</th>
					</tr>
					<tr th:each="orderItem:${orderItemList}">
						<td>
							<div class="text-center">
								<img th:src="@{'/img_curry/'+${orderItem.item.imagePath}}"
									class="img-responsive img-rounded item-img-center" width="100"
									height="300"><br> <span
									th:text="${orderItem.item.name}">じゃがバターベーコン</span>
							</div>
						</td>
						<td><span class="price" th:text="'&nbsp;'+${orderItem.size}">&nbsp;Ｌ</span>
							<span th:if="${orderItem.size}=='M'"
							th:text="${#numbers.formatInteger(orderItem.item.priceM, 1, 'COMMA')}+'円'">&nbsp;&nbsp;2,380円</span>
							<span th:if="${orderItem.size}=='L'"
							th:text="${#numbers.formatInteger(orderItem.item.priceL, 1, 'COMMA')}+'円'">&nbsp;&nbsp;2,380円</span>
							<span th:text="'&nbsp;&nbsp;' + ${orderItem.quantity} + '個'">&nbsp;&nbsp;1個</span>
						</td>
						<td>

							<div class="center">

								<img
									th:src="@{'/img_rice/' + ${orderItem.orderRice.rice.imagePath}}"
									class="img-responsive img-rounded item-img-center" width="50"
									height="150"> <br> <span
									th:text="${orderItem.orderRice.rice.name}"></span>
							</div>

						</td>
						<td>

							<table th:unless="${#lists.isEmpty(orderItem.orderToppingList)}"
								class="text-left" style="table-layout: fixed">
								<tr th:each="orderTopping : ${orderItem.orderToppingList}">
									<td style="width: 300px" class="text-center">
										<ul class="col-sm-12">
											<li class="text-left" th:text="${orderTopping.topping.name}"></li>
										</ul>

									</td>
									<td style="width: 60px" class="text-left"><span
										th:if="${orderItem.size.toString() == 'M'}"
										class="toppingPrice"
										th:text="${#numbers.formatInteger(orderTopping.topping.priceM, 1, 'COMMA')} + '円'"></span>
										<span th:if="${orderItem.size.toString() == 'L'}"
										class="toppingPrice"
										th:text="${#numbers.formatInteger(orderTopping.topping.priceL, 1, 'COMMA')} + '円'"></span>
									</td>
								</tr>
							</table> <span th:if="${#lists.isEmpty(orderItem.orderToppingList)}">---</span>




						</td>
						<td>
							<div class="text-center">
								<span
									th:text="${#numbers.formatInteger(orderItem.getSubTotal(), 1, 'COMMA')}+'円'">3,280円</span>
							</div>
						</td>
					</tr>
				</tbody>
			</table>

		</div>
	</div>
		<div class="row">
			<div class="col-xs-offset-2 col-xs-8">
				<div class="form-group text-center">
					<form>
					<div>
					<input type="radio" value="1" onclick="hyoji('block')" name="selectPoints">ポイントを使用する<br>
					<input type="radio" value="2" onclick="hyoji('none')" name="selectPoints" checked>ポイントを使用しない
					</div>
					</form><br>
					<div id="selectPoints">
					<span class="message" style="color:red"></span>
					<input type="text" th:value="${points}" id="points">ポイント
					<button id="useButton">使う</button><br>
					<input type="hidden" th:value="${points}" id="userPoints">
					</div>
					<span id="total-price" class="tax" th:text="'消費税：' + ${#numbers.formatInteger(tax, 1, 'COMMA')} + '円'">消費税：8,000円</span><br>
					<span id="total-price" class="totalPrice" th:text="'ご注文金額合計：' + ${#numbers.formatInteger(totalPrice, 1, 'COMMA')} + '円'" th:value="${totalPrice}">ご注文金額合計：38,000円 (税込)</span><br>
					<div id="newTotalPriceDisplay">
					<span id="total-price" class="text"></span>
					<span id="total-price" class="newTotalPrice"></span>
					</div>
					<p></p>
				</div>
			</div>
		</div>

		<!-- table -->
		<form action="order_finished.html" th:action="@{/order}" th:object="${orderForm}" id="orderForm">
			
			<div class="row">
				<div
					class="table-responsive col-lg-offset-3 col-lg-6 col-md-offset-1 col-md-10 col-sm-10 col-xs-12">
					<h3 class="text-center">お届け先情報</h3>
					<div class="h-adr">					
					<table class="table table-striped item-list-table">
						<tbody>
							<tr>
								<td>
									<div class="text-center">お名前</div>
								</td>
								<td>
									<div th:if="${#fields.hasErrors('name')}" th:errors="*{name}" style="color:red" class="text-center"></div>
									<input type="text" th:field="${user.name}" class="form-control validate[required,maxSize[50]]">
								</td>
							</tr>
							<tr>
								<td>
									<div class="text-center">メールアドレス</div>
								</td>
								<td>
									<div th:if="${#fields.hasErrors('email')}" th:errors="*{email}" style="color:red" class="text-center"></div>
									<input type="text" th:field="${user.email}" class="form-control validate[required,custom[email]]">
								</td>
							</tr>
							<tr>
								<td>
									<div class="text-center">郵便番号</div>
								</td>
								<td>
									<div class="col-xs-8">
									<div class="text-left">
									<div class="input-group">

									<div th:if="${#fields.hasErrors('zipcodefirst')}" th:errors="*{zipcodefirst}" style="color:red" class="text-center"></div>
									<input type="text" th:field="${user.zipcodefirst}" class="form-control validate[required,funcCall[size[3]]]" onKeyUp="AjaxZip3.zip2addr('zipcodefirst','zipcodelast','address','address');"><!--  &nbsp;&nbsp;<button>住所検索</button>-->
									<span class="input-group-addon">-</span>
									<div th:if="${#fields.hasErrors('zipcodelast')}" th:errors="*{zipcodelast}" style="color:red" class="text-center"></div>
									<input type="text" th:field="${user.zipcodelast}" class="form-control validate[required,funcCall[size[4]]]" onKeyUp="AjaxZip3.zip2addr('zipcodefirst','zipcodelast','address','address');">
									</div>
									</div>
									</div>
								</td>
							</tr>
							<tr>
								<td>
									<div class="text-center">住所</div>
								</td>
								<td>
									<div th:if="${#fields.hasErrors('address')}" th:errors="*{address}" style="color:red" class="text-center"></div>
									<textarea th:field="${user.address}" class="form-control validate[required]"></textarea>
								</td>
							</tr>
							<tr>
								<td>
									<div class="text-center">電話番号</div>
								</td>
								<td>
									<div th:if="${#fields.hasErrors('address')}" th:errors="*{address}" style="color:red" class="text-center"></div>
									<input type="text" th:field="${user.telephone}" class="form-control validate[required,minSize[10],maxSize[11]]">
								</td>
							</tr>
							<tr>
								<td>
									<div class="text-center">配達日時</div>
								</td>
								<td>
									<div class="form-group">
										<div class="row">
											<span th:text="${message}" style="color: red"></span>
											<div class="col-sm-12">
											<div th:if="${#fields.hasErrors('orderDate')}"
												th:errors="*{orderDate}" style="color: red"
												class="text-left"></div>
												</div>
											<div class="col-sm-6">
												<input type="date" name="name" id="date"							
													class="form-control input-sm validate[required]" th:field="*{orderDate}" min=""/>
											</div>

										</div>
										<div class="row">
										<div class="col-sm-12">
											<div th:if="${#fields.hasErrors('time')}" th:errors="*{time}"
												style="color: red" class="text-left"></div>
											</div>
											<div class="col-sm-12">
												<label class="radio-inline" th:each="time:${orderTime}">
													<input type="radio"
														name="responsibleCompany" checked="checked" th:field="*{time}" th:value="${time.key}" th:text="${time.value}" class="validate[required]"><br>												
												</label>
											</div>
										<!-- 	
											<div class="form-inline">
									
									
									
									<table>
											<tbody>
												<th:block th:each="time, status:${orderTime}">
													<th:block th:if="${status.index%3==0}">
														<tr>
													</th:block>
													
													<td>
													<span class="text-left">
													<label class="radio-inline">
														<input type="radio" name="responsibleCompany"
													checked="checked" th:field="*{time}" th:value="${time.key}"
													th:text="${time.value}" class="pull-left">
													</label>
													</span>
													</td>
													
													<th:block th:if="${status.index%3==2}">
                       									</tr>
                    								</th:block>
												</th:block>
											
											</tbody>										
									</table>
									</div> -->
											
										</div>
									</div>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>

			<!-- table -->
			<div class="row">
				<div
					class="table-responsive col-lg-offset-3 col-lg-6 col-md-offset-1 col-md-10 col-sm-10 col-xs-12">
					<h3 class="text-center">お支払い方法</h3>
					<div th:if="${#fields.hasErrors('paymentMethod')}"
						th:errors="*{paymentMethod}" style="color: red"
						class="text-center"></div>
					<table class="table table-striped item-list-table">
						<tbody>
							<tr>
								<td>
									<div class="text-center">代金引換</div>
								</td>
								<td>
									<div class="row">
										<div class="col-sm-12">
											<label class="radio-inline">
												<input type="radio"
													name="responsibleCompany" checked="checked" th:field="*{paymentMethod}" value="1" class="validate[required]">
												代金引換
											</label>
										</div>
									</div>
								</td>
							</tr>
							<tr>
								<td>
									<div class="text-center">クレジットカード決済</div>
								</td>
								<td align="center">
									<div class="row">
										<div class="col-sm-12">
											<label class="radio-inline">
												<input type="radio"
													name="responsibleCompany" checked="checked" th:field="*{paymentMethod}" value="2" class="validate[required]">
												クレジットカード
											</label><br><br>
										</div>
									</div>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
			<input type="hidden" name="totalPrice" th:value="${price}">
			<input type="hidden" id="newTotalPrice" name="discountPrice" value="0">
			<input type="hidden" id="usedPoint" name="usedPoints" value="0">
			<div class="row">
				<div class="col-xs-offset-4 col-xs-4">
					<div class="form-group">
						<input class="form-control btn btn-warning btn-block" type="submit" value="この内容で注文する" id="order">
					</div>
				</div>
			</div>
		</div>
	</form>
	<!-- end container -->
	<!-- script
		src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script> -->
	<script th:src="@{../js/bootstrap.min.js}"></script>
	<script type="text/javascript">
		$(function() {
			$('#order').on('click', function() {
				$(this).prop('disabled', true);
				$('form').submit();
			});
		});
		
		$(function() {
			$("#selectPoints").hide();
		});
		
		function hyoji(disp){
			document.getElementById("selectPoints").style.display=disp;
			if(disp=="none"){
				document.getElementById("newTotalPriceDisplay").style.display=disp;
				document.getElementById("newTotalPrice").value=0;
				document.getElementById("usedPoint").value=0;
				$("#order").prop('disabled', false);
			}else{
				document.getElementById("newTotalPriceDisplay").style.display=disp;
			}
		}
		
		$(function() {
			$("#useButton").on("click",function() {
				
				var strPoints = $("#points").val();
				var strUserPoints = $("#userPoints").val();
				var points = Number(strPoints);
				var userPoints = Number(strUserPoints)
				console.log(points);
				console.log(userPoints);
				if(points==""){
					$(".message").text("入力必須です").show();
					$(".text").hide();
					$(".newTotalPrice").hide();
					$("#order").prop('disabled', true);
				}else if(Number.isInteger(points)==false) {
					$(".message").text("整数を半角数字で入力してください").show();
					$(".text").hide();
					$(".newTotalPrice").hide();
					$("#order").prop('disabled', true);
				}else if(points<0){
					$(".message").text("不正な入力値です").show();
					$(".text").hide();
					$(".newTotalPrice").hide();
					$("#order").prop('disabled', true);
				}else if(userPoints<points) {
					$(".message").text("保有ポイントを上回っています").show();		
					$(".text").hide();
					$(".newTotalPrice").hide();
					$("#order").prop('disabled', true);
				}else {
				$("#order").prop('disabled', false);
				$(".message").hide();
				$("#usedPoint").val(points);
				var strTotalPrice = $(".totalPrice").text();
				var totalPrice = strTotalPrice.replace(/[^0-9^\.]/g,"");
				var newTotalPrice = totalPrice - points;
				$(".text").text("ポイント利用後：").show();
				$(".newTotalPrice").text(newTotalPrice.toLocaleString()+"円").show();
				$("#newTotalPrice").val(newTotalPrice);
				}
			});
		});
		
		function size(field, rules, i, options) {
			var num = rules[i+2];			
			var num2 = Number(num);			
			if (field.val().length !== num2) {
				return '* ' + num.toString() + '桁で入力してください';
			}
		}
		
		$(function () {
	        $("form").validationEngine("attach", {focusFirstField: false});

	        $("input").on("input", function () {
	            if ($("form").validationEngine("validate")) {
	                $("#order").prop("disabled", false);
	            } else {
	                $("#order").prop("disabled", true);
	            }
	        });

	        $("#order").on("click", function () {
	            if ($("form").validationEngine("validate")) {
	                $("form").submit();
	            }
	        });
	    });
	</script>
</body>
</html>